name: Load Tests

on:
  workflow_dispatch:

jobs:
  test:
    environment:
      name: staging
    name: Authorization Load Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Create Verify Username Uniqueness Load Test ConfigMap
      uses: steebchen/kubectl@master
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
        KUBECTL_VERSION: "1.20"
      with:
        args: '"create configmap -n kwetter-testing verify-username-uniqueness-load-test-configmap --from-file src/Testing/Kwetter.LoadTests/test.js"'

    - name: Run Verify Username Uniqueness Load Test
      uses: steebchen/kubectl@master
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
        KUBECTL_VERSION: "1.20"
      with:
        args: '"apply -n kwetter-testing -f ./K8s/k6/verify-username-uniqueness-load-test.yaml"'
    
    - name: Get K6
      uses: steebchen/kubectl@master
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
        KUBECTL_VERSION: "1.20"
      with:
        args: '"logs -n kwetter-testing -l k6_cr=verify-username-uniqueness-load-test"'

    #- name: Clean Up Load Tests
    #  uses: steebchen/kubectl@master
    #  env:
    #    KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
    #    KUBECTL_VERSION: "1.20"
    #  with:
    #    args: '"delete -n kwetter-testing -f ./K8s/k6/verify-username-uniqueness-load-test.yaml"'